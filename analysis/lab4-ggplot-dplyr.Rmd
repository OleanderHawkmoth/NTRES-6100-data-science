---
title: "Lab 4: Data exploration with the gapminder dataset"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(base.dir = "../docs/", root.dir = "../docs/")
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

<br>

## Goals for today

1. Continue to practice data visualization with `ggplot2`
 
2. Continue to practice data transformation with `dplyr`

3. Integrate 1) and 2) to explore the `gapminder` dataset

<br>
<br>

## General instructions

* Today, we'll combine the powerful data transformation tools in `dplyr` and the data visualization tools in `ggplot2` to continue our visual exploration of global trends in public health and economics compiled by the [Gapminder project](https://www.gapminder.org/about/).

<br>

* To start, first open a new RMarkdown file in your course repo,  set the output format to `github_document`, save it in your `lab` folder as `lab3.Rmd`, and work in this RMarkdown file for the rest of this lab. 

<br>

* Now that you have learned how to subset data using different functions in `dplyr`, we will work with the full `gapminder` dataset provided in the R package `dslabs`. Let's start by installing the `dslabs` package if you don't have it installed already. Then, we need to load it with the `library()` function. We also need to load the `tidyverse` package because it contains ggplot.

```{r}
library(dslabs) #install.packages("dslabs")
library(tidyverse)
```

<br>

* As a reminder, to get familar with this dataset, you might want to use functions like `View()`, `dim()`, `colnames()` , and `?`. You will see that the dataset includes the following variables:

    - country
    - year
    - infant_mortality (infant deaths per 1000)
    - life_expectancy
    - fertility (average number of children per woman)
    - population (per country)
    - gpd (per country)
    - continent
    - region (geographical region)

<br>

## Exercise 1: Use data transformation and visualization to answer the following close-ended questions in breakout rooms (45 min)

<br>

You may first answer these questions based on your intuition, and then use the `gapminder` dataset to verify if your intuition is correct. 

Some solutions are provided for each question, but we highly recommend you **not to look at them unless you are really stuck**.

<br>

### Question 1. There are roughly seven billion people in the world today. Which map shows where people live? (Each figure represents 1 billion people.)

![](https://s3.eu-west-1.amazonaws.com/static.gapminder.org/GapminderMedia/wp-uploads/20170330195501/Results-for-the-Swedish-Public-on-the-Gapminder-Test-2017%E2%80%99-1024x244.jpg)

Hint: use the data from 2015

<br> 

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2015) %>%
  group_by(continent) %>%
  summarize(population_in_billion=sum(population)/10^9) %>%
  ggplot(aes(x=continent, y=population_in_billion)) +
  geom_col()
```

</details>

<br>

### Question 2. What is the life expectancy of the world population?

A. 50 years  
B. 60 years  
C. 70 years  

Hint: use the data from 2015

<br> 

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2015) %>%
  summarize(life_expectancy=sum(life_expectancy*population)/sum(population))
```

</details>

<br>

### Question 3. What is the gap in life expectancy between Europe and Africa?

A. 5 years  
B. 15 years  
C. 25 years  

Hint: use the data from 2015

<br> 

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2015) %>%
  group_by(continent) %>%
  summarize(life_expectancy=sum(life_expectancy*population)/sum(population)) %>%
  ggplot(aes(x=continent, y=life_expectancy)) +
  geom_col()

gapminder %>%
  filter(year==2015) %>%
  ggplot(aes(x=continent, y=life_expectancy)) +
  geom_jitter(aes(color=continent),height = 0) +
  geom_boxplot(alpha=0, outlier.alpha = 0)
```

</details>

<br>

### Question 4. What is the general relationship between per-capita GDP and fertility rate? 

A. positive relationship  
B. negetive relationship  
C. no relationship  

Hint: use the data from 2000

<br>

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2000) %>%
  ggplot(aes(y=fertility, x=gdp/population)) +
  geom_point() +
  geom_smooth(se=F, method = "lm")
```

</details>

<br>

### Question 5. If you break down the relationship between per-capita GDP and fertility rate by continent, which continent (or regions) stands out as an outlier? (Bonus question: why might this be?)

A. Africa  
B. Asia  
C. Europe  

Hint: use the data from 2000

<br>

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2000) %>%
  ggplot(aes(y=fertility, x=gdp/population, color=continent)) +
  geom_point() +
  geom_smooth(se=F, method = "lm") +
  facet_wrap(~continent, scales = "free_y")
```

```{r fig.width=10}
eu_2000 <- gapminder %>%
  filter(year==2000, continent == "Europe") 
eu_2000 %>%
  filter(fertility > 1.5, gdp/population > 20000) %>%
  ggplot(aes(y=fertility, x=gdp/population, color=region)) +
  ggrepel::geom_label_repel(aes(label=country)) +
  geom_point(data=eu_2000)
```

</details>

<br>

### Question 6. Rank the following countries in infant mortality rate in 2015. 

Turkey, Poland, South Korea, Russia, Vietnam, South Africa

<br>

*One possible solution*
<details>
  <summary>click to expand</summary>

```{r}
gapminder %>%
  filter(year==2015, country %in% c("Turkey", "Poland", "South Korea", "Russia", "Vietnam", "South Africa")) %>%
  arrange(infant_mortality) %>%
  select(country, infant_mortality) %>% 
  knitr::kable()
```

</details>

<br>

## Recap (10 minutes)

Share your findings, challenges, and questions with the class. 

<br>

## Short break (10 min)

<br>

## Exercise 2: Use data transformation and visualization to explore the following open-ended questions in breakout rooms (40 min)

<br>

### Question 1. Explore how much the gap in infant mortality, life expectancy, and per capita GDP between Western countries and the rest of the world have changed from 1960 to 2010. 

<br>

Suggestions:

* Visualizing the entire time series and taking certain snapshots of time (e.g. one data point every decade) can both be useful approaches.

* The range in per capita GDP can be very high, with most countries having low values but a few countries having very high values, so a log transformation may be useful.

* You can try different definitions of "Western countries" and the "rest of the world".

* You can also analyze different subgroups within the broad categorizations of "Western countries" and the "rest of the world" separately.

* Try to explore different geometric objects. Line plot, scatter plot, density plot, box plot, bar plot, and others can all be useful.

<br> 

*Some ideas if you are really stuck*
<details>
  <summary>click to expand</summary>

```{r}
years <- c(1960, 1970, 1980, 1990, 2000, 2010)
continents <- c("Europe", "Asia")
gapminder %>% 
  filter(year %in% years & continent %in% continents) %>%
  ggplot(aes(log(gdp/population), life_expectancy, col = continent)) +
  geom_point() +
  facet_wrap(~year) 

gapminder %>% 
  filter(continent %in% continents) %>%
  ggplot(aes(x=year, y=life_expectancy, group=country)) +
  geom_line()+
  facet_wrap(~continent) 

gapminder %>% 
  filter(year %in% c(1960, 2010)) %>%
  ggplot(aes(x=life_expectancy, fill=continent)) +
  geom_density(alpha=0.5)+
  facet_wrap(~year, nrow=2) 

gapminder %>% 
  filter(year %in% c(1960, 2010)) %>%
  ggplot(aes(x=log(gdp/population), fill=continent)) +
  geom_density(alpha=0.5)+
  facet_wrap(~year, nrow=2) 

gapminder %>% 
  filter(year %in% c(1960, 2010)) %>%
  ggplot(aes(continent, log(gdp/population), fill = as.character(year))) +
  geom_boxplot()
```

</details>

<br>

## Recap (10 minutes)

Share your findings, challenges, and questions with the class. 

<br>

**END LAB 3**

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
